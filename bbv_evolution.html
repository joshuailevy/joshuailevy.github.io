<!DOCTYPE html>

<meta charset="utf-8"/>
<html>
 <head>
<style>

body {
    box-sizing: border-box;
    margin: 20px;
/*    width:100%;
    height: 100vh;*/

    display:flex;
    justify-content: center;
    align-items: center;
}

#disclaimer{
	align-self: start;
  border: 1px solid red;
  color: red;
	grid-row-start: 1;
	grid-row-end: 2;
	grid-column-start: 3;
  grid-column-end: 4;

}

	.Qs{
	color:#000000;
	font-weight: normal;
	font-family: 'Arial', sans-serif;   
	font-size: 26px;
}

	#title {
	/*margin: 1em 0 0.5em 0;*/
	color: #343434;
	font-weight: normal;
	font-family: 'Ultra', sans-serif;   
	font-size: 36px;
	line-height: 42px;
	text-transform: uppercase;
	text-shadow: 0 2px white, 0 3px #777;
	   grid-row-start: 1;
		  grid-row-end: 2;
		grid-column-start: 1;
		  grid-column-end: 4;
		}




		#canvas1{
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    display: block;
		}
		#bigDiv{
		 /*margin: auto;*/
  width: 80%;
/*  padding-left: 0;
    padding-right: 0;*/
    /*margin-left: auto;*/
    margin-right: auto;
  /*border: 3px solid green;*/
  padding: 5px;

		}

		#gridCont{
			text-align:center;
			display: grid;
			grid-template-columns:650px 450px 650px;
			grid-column-gap:60px;
			grid-template-rows:250px 850px 100px;
			align-items:center;

		}


		#gridContInfo{
		text-align:center;
		display: grid;
		grid-template-columns:600px 600px 600px;
		grid-column-gap:60px;
		grid-template-rows:1000px;
		align-items:center;
		}
		#lastBin{
				  border: 1px solid rgba(0, 0, 0, 0.8);
	  padding: 20px;
		   grid-row-start: 3;
		  grid-row-end: 4;
		grid-column-start: 1;
		  grid-column-end: 4;
		}
		#infoc1{
		  /*border: 1px solid rgba(0, 0, 0, 0.8);*/
		  /*padding: 20px;*/
		  align-self: start;
			grid-column-start: 1;
		  grid-column-end: 2;
		}
		#infoc2{
			align-self: start;
		  grid-column-start: 2;
		  grid-column-end: 3;
		}
		#infoc3{
			align-self: start;
		  grid-column-start: 3;
		  grid-column-end: 4;
		}
		#container{
			align-self: start;
			grid-column-start: 1;
		  grid-column-end: 2;
		    grid-row-start: 2;
		  grid-row-end: 3;
		}
		#container2{
			align-self: start;
			grid-column-start: 2;
		  grid-column-end: 3;
		    grid-row-start: 2;
		  grid-row-end: 3;
/*		    flex-direction: column;
	*/	}
		#container3{
			align-self: start;
			grid-column-start: 3;
		  grid-column-end:4;
		    grid-row-start: 2;
		  grid-row-end: 3;
/*		    flex-direction: column;
*/	}

		#paramList{
			vertical-align: top;
	    padding: 20px;
	    margin: 0 auto;
		}

		#canvasDiv{
	    padding: 20px;
	    margin: 0 auto;
		display:inline-block;
		}

		#tester{
		    margin-left: auto;
		    margin-right: auto;
		}
		#tester2{
		    margin-left: auto;
		    margin-right: auto;
		}
		#tester3{
		    margin-left: auto;
		    margin-right: auto;
		}

		#tester4{
		    margin-left: auto;
		    margin-right: auto;
		}

		#startBtn {
		  display: inline-block;
		  padding: 15px 25px;
		  font-size: 24px;
		  cursor: pointer;
		  text-align: center;
		  text-decoration: none;
		  outline: none;
		  color: #fff;
		  background-color: #4CAF50;
		  border: none;
		  border-radius: 15px;
		  box-shadow: 0 9px #999;
		}
		#stopBtn {
		  display: inline-block;
		  padding: 15px 25px;
		  font-size: 24px;
		  cursor: pointer;
		  text-align: center;
		  text-decoration: none;
		  outline: none;
		  color: #fff;
		  background-color: #f44336;
		  border: none;
		  border-radius: 15px;
		  box-shadow: 0 9px #999;
		}

		#ffwBtn {
		  display: inline-block;
		  padding: 15px 25px;
		  font-size: 24px;
		  cursor: pointer;
		  text-align: center;
		  text-decoration: none;
		  outline: none;
		  color: #fff;
		  background-color: #006600;
		  border: none;
		  border-radius: 15px;
		  box-shadow: 0 9px #999;
		}

		.button:hover {background-color: #3e8e41}

		.button:active {
		  background-color: #3e8e41;
		  box-shadow: 0 5px #666;
		  transform: translateY(4px);
		}

		.modebar{
		      display: none !important;
		}
	</style>
 </head>
 <body>
 <div id='bigDiv'>
<div id='gridCont' class="grid-container" margin='auto'>

<h1 id='title' align="center">
	Braitenberg Vehicle Evolution! 
	<hr>
</h1>
<p id = "disclaimer"> GENERAL DISCLAIMER: While meant to illustrate the evolutionary algorithm used in our work, this is a simplified version of the problem concerned with a single simple objective. </p>
<div  id="container" align="center">
<h2> Simulation of each generation </h2>
<div id="canvasDiv">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<canvas id="canvas1"></canvas>
<div id="paramList" align="center">
	<button class='button' id='startBtn' ><i class="material-icons">play_arrow</i></button>
	<button class='button' id='ffwBtn' ><i class="material-icons">fast_forward</i></button>
	<button class='button' id='stopBtn'><i class="material-icons">stop</i></button>
</div>
</div>
</div>


<div  id="container2" align="center" flex-direction="column">
<h2> Sensor Parameters </h2>
<div id="tester2" ></div>
<br><br>
<h2> Connectivity Parameters </h2>

<div id="tester3" ></div>
</div>

<div  id="container3" align="center">
<h2> How well does the vehicle avoid heat?</h2>
<div id="tester"></div>
<br>
<h2> Avoidance Index Evolution</h2>
<div id="tester4" ></div>
</div>
<!-- <br style = “line-height:500px;”> -->
<h2 id='lastBin' align='center'> See below for more information</h2>
</div>
<div id='gridContInfo' class="grid-container">
<div id="infoc1">
<h2> Braitenberg vehicle </h2>
<img src="fly_vehicle.svg" alt="Approximating a fly">
</div>
<div id="infoc2">
<h2> Vehicle Parameters </h2>
<p class="Qs" align='left'>
todo-We describe a nonlinear (logistic) sensory response, h, as a function of the temperature above baseline, s, at the height of the sensor (e.g. a fly's antenna). \[ h(s) = \frac{1}{1+e^{(-a\times s+b)}} .\] Rather than a true readout of temperature, s is effected by time correlated noise, \( \epsilon(t) \), simulated by an <a href=" 
https://en.wikipedia.org/wiki/Ornstein%E2%80%93Uhlenbeck_process"> Ornstein-Uhlenbeck </a> process. The processed input is linearly combined (using the Ipsilateral and Contralateral weights) to get the wheel speed, for example, 
\[ v_L = h(s_L) w_I + h(s_R) w_C + v_0 + \gamma (t), \]
where \(v_0\) is the baseline walking speed and \(\gamma (t)\) is time correlated noise. 
</p>
</div>

<div id="infoc3">
<h2> Avoidance Index </h2>

<p class="Qs" align='left'>

The avoidance index (AI) is a measurement of thermal preference over time. An AI score of 1 signifies perfect avoidance of the heat stimulus (pink side), while -1 shows perfect attraction to the heat stimulus. If there is no preference, we expect to see an AI score of approximately 0. Mathematically, we write this as 
\[AI = \frac{\text{time at BT} – \text{time at TT}}{\text{total time}}\]
<br>
</p>

<h2> How do we evolve the population? </h2> 
<p class="Qs" align='left'>
After each generation, we take the strongest performers (here, we take the top 3) and allow them to continue to the next generation. The rest of the next generation is then composed of mutations (i.e. random perturbations to the parameters of the winners) or crossovers (i.e. random mixtures of the parameters of each of the winners).
</p>
</div>
<hr>
</div>
<hr>
<p align='right'>
© Joshua I. Levy 2020
</p>

</div>
<!-- 
 -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript" src="splines.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
 <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>

<script type="text/javascript">

var canvas = document.getElementById('canvas1');
var sliderIpsi = document.getElementById("slideIpsi");
var sliderContra = document.getElementById("slideContra");
var sliderSpeed = document.getElementById("slideSpeed");



fix_dpi()

var cg3 = document.getElementById('container3')
var cg2 = document.getElementById('container2')
var cg1 = document.getElementById('container')
canvas.width = Math.max(cg3.clientWidth,cg3.clientHeight);
canvas.height = Math.max(cg3.clientWidth,cg3.clientHeight);
console.log(canvas.width,canvas.height)
cg1.clientHeight = cg3.clientHeight;
var ctx = canvas.getContext('2d');
////
ctx.beginPath();
// adding the "hot" quadrants
ctx.fillStyle = 'red';
ctx.globalAlpha = 0.2;
ctx.arc(canvas.width/2,canvas.width/2,canvas.width/2,3*Math.PI/2,Math.PI, true)
ctx.lineTo(canvas.width/2,canvas.width/2)
ctx.fill();
ctx.closePath();
ctx.beginPath();

ctx.fillStyle = 'red';
ctx.globalAlpha = 0.2;
ctx.arc(canvas.width/2,canvas.width/2,canvas.width/2,Math.PI/2,0, true)
ctx.lineTo(canvas.width/2,canvas.width/2)
ctx.fill();
ctx.closePath();
ctx.restore()

//exterior circle
ctx.beginPath();
ctx.arc(canvas.width/2, canvas.height/2,canvas.height/2,0,2*Math.PI, true)
ctx.stroke()
ctx.closePath()

ctx.restore()

var raf;
var data1;
var center = canvas.width/2;
var arenaWidth = 38;
var scaleFactor = arenaWidth/canvas.width;
var b = 0.75;
var drawing = false;
//read in temperature data
$.ajax({
	async:false,
	url: 'http://joshuailevy.github.io/contour_dat30_40.txt',
	success: function(data) {
	data1 = JSON.parse(JSON.parse(data));
  	console.log('success reading in temp data');
	},
});

var t1 = data1['temp40'];
var x1 = data1['xcoord'];
var dt = 1./30.;
var sqrtdt = Math.sqrt(dt);
var avoid_array = [];
var time_array = [];
var timepointsBeforeEvolution = 1200;


var layout = {
	height:300,
	width:400,
	title:{
		text: "Generation 0",
		font: {
        size: 18,
        color: '#7f7f7f'
      },
  },
  xaxis: {
    title: {
      text: 'Time',
      font: {
        size: 18,
        color: '#7f7f7f'
      }
    },
    range: [0,timepointsBeforeEvolution*dt]
  },
  yaxis: {
    title: {
      text: 'Avoidance Index (AI)',
      font: {
        size: 18,
        color: '#7f7f7f'
      }
    },
    range: [-1.1, 1.1]
},
  margin: {
    l: 50,
    r: 10,
    b: 40,
    t: 40,
    pad: 2
  },
};

var layout2 = {
width:275,
height:275,

  xaxis: {
    showgrid: true,
    title: {
      text: 'a',
      font: {
        size: 18,
        color: '#7f7f7f'
      }
    },
    range: [0,11]
  },
  yaxis: {    
  	showgrid: true,
    title: {
      text: 'b',
      font: {
        size: 18,
        color: '#7f7f7f'
      }
    },
    range: [0,1.1]
},
  margin: {
    l: 50,
    r: 10,
    b: 40,
    t: 40,
    pad: 2
  },
  showlegend:false,
  //   legend: {
  //   x: 1,
  //   xanchor: 'right',
  //   y: 1
  // }
};

var layout3 = {
	width:300,
	height:300,
  xaxis: {
    showgrid: true,
    title: {
      text: 'Ipsilateral Weight (wI)',
      font: {
        size: 18,
        color: '#7f7f7f'
      }
    },
    range: [-25,25]
  },
  yaxis: {
    showgrid: true,
    title: {
      text: 'Contralateral Weight (wC)',
      font: {
        size: 18,
        color: '#7f7f7f'
      }
    },
    range: [-25,25]
},
 margin: {
    l: 50,
    r: 10,
    b: 40,
    t: 10,
    pad: 2
  },
  showlegend: false,
};

var layout4 = {
	height:300,
	width:500,
  xaxis: {
  	showgrid: true,
    title: {
      text: 'Generation',
      font: {
        size: 18,
        color: '#7f7f7f'
      }
    },
    range:[-0.1,1]
  },
  yaxis: {
  	showgrid: true,
    title: {
      text: 'Median AI',
      font: {
        size: 18,
        color: '#7f7f7f'
      }
    },
    range: [-1.1, 1.1],
},
    margin: {
    l: 50,
    r: 10,
    b: 40,
    t: 10,
    pad: 2
  },
};
var colors = ['#ff5733','#7dff33','#3346ff','#f9ff33','#ff9333','#a833ff','#26f7f7','#581845','#e60d34','#000000','#ff33cc']
var numVehicles = 11;
var pltList = []
for (i = 0; i < numVehicles; i++) {
	pltList.push({ name: 'Vehicle '.concat(i.toString()),mode: 'lines',line:{color:colors[i]}})
}

var trace2 = {type: 'scatter',mode: 'markers'};
var trace3 = {type: 'scatter',mode: 'markers'};
var trace4 = {y:[],type: 'scatter',mode: 'lines+markers'};

Plotly.newPlot('tester', pltList,layout);
Plotly.newPlot('tester2',[trace2,trace2],layout2)
Plotly.newPlot('tester3',[trace3,trace3],layout3)
Plotly.newPlot('tester4',[trace4],layout4)

// console.log(Math.max(...x1),Math.min(...x1))
var temps  = Smooth(t1,{
	method: 'linear',
	scaleTo: [Math.min(...x1)*-1,Math.max(...x1)*-1],
})
// console.log(t1,x1)
//create interpolant so we can calculate temperatures at the antennae. 

var vehicle = {
	v: -1,
	width: canvas.width*0.02,
	height:canvas.width*0.04,
	// color: 'blue',
	// angle: Math.PI/4*0,
	// x: canvas.width/2,//centroid position
	// y: canvas.height/2,
	draw: function() {

		ctx.save()
		ctx.beginPath();
		ctx.translate(this.x, this.y);
		ctx.rotate(this.angle);
		ctx.translate(-this.x, -this.y);
		ctx.strokeRect(this.x-this.width/2, this.y-this.height/2, this.width,this.height);
		ctx.fillStyle = this.color;
		ctx.fill()
		ctx.closePath();
		//wheels
		ctx.beginPath();
		ctx.fillStyle =  this.color;
		ctx.rect(this.x-.8*this.width, this.y+this.height*0.2, .3*this.width,.4*this.height);
		ctx.rect(this.x+this.width/2, this.y+this.height*0.2, 0.3*this.width,.4*this.height);
		ctx.fill();
		ctx.closePath();
		//sensors
		ctx.beginPath();
		ctx.fillStyle = 'red';
		ctx.arc(this.x-.2*this.width,this.y-.6*this.height,2,0,2*Math.PI, true)
		ctx.arc(this.x+this.width*0.2,this.y-.6*this.height,2,0,2*Math.PI, true)
		ctx.fill();
		ctx.closePath();

		ctx.restore()
	}
};

var i;
var vehicleList = [];
var ints = []
var hotTime = [];
var totTime = [];
var r1 = [];

for (i = 0; i < numVehicles; i++) {
	// randVal = Math.random;
	vehicleList.push(Object.assign({angle: Math.random()*2*Math.PI,a:10.*Math.random(),b:.975*Math.random()+0.025,wI:40*(Math.random()-0.5),wC:40*(Math.random()-0.5),color:colors[i],x:center+100*(Math.floor(Math.random()*2)*2-1),y:center},vehicle));
	avoid_array.push([])
	ints.push(i)
	hotTime.push([0.])
	time_array.push([])
	totTime.push([0.])
} 
var aList = [];
var bList = [];
var wIList = [];
var wCList = [];

let histaList = new Set([]);
let histbList = new Set([]);
let histwIList = new Set([]);
let histwCList = new Set([]);

for (i = 0; i < numVehicles; i++) {
	aList.push(vehicleList[i].a);
	bList.push(vehicleList[i].b);
	wIList.push(vehicleList[i].wI);
	wCList.push(vehicleList[i].wC);
	r1.push(euler_maru());
}

var firstTime = 1;

function fix_dpi() {
//get DPI
dpi = window.devicePixelRatio;//get canvas
canvas = document.getElementById('canvas1');
//get CSS height
style_height = getComputedStyle(canvas).getPropertyValue("height").slice(0, -2);
style_width = getComputedStyle(canvas).getPropertyValue("width").slice(0, -2);//scale the canvas
canvas.setAttribute('height', style_height * dpi);
canvas.setAttribute('width', style_width * dpi);}

function quickselect_median(arr) {
   const L = arr.length, halfL = L/2;
   if (L % 2 == 1)
      return quickselect(arr, halfL);
   else
      return 0.5 * (quickselect(arr, halfL - 1) + quickselect(arr, halfL));
}

function quickselect(arr, k) {
   // Select the kth element in arr
   // arr: List of numerics
   // k: Index
   // return: The kth element (in numerical order) of arr
   if (arr.length == 1)
      return arr[0];
   else {
      const pivot = arr[0];
      const lows = arr.filter((e)=>(e<pivot));
      const highs = arr.filter((e)=>(e>pivot));
      const pivots = arr.filter((e)=>(e==pivot));
      if (k < lows.length) // the pivot is too high
         return quickselect(lows, k);
      else if (k < lows.length + pivots.length)// We got lucky and guessed the median
         return pivot;
      else // the pivot is too low
         return quickselect(highs, k - lows.length - pivots.length);
   }
}


function euler_maru(){
	sigma1 = 0.1;
	tConst1 = 0.1;
	noise = []; 
	noise.length = timepointsBeforeEvolution;
	noise[0] =0;
	sigma1 = Math.sqrt(2./tConst1)*sigma1*sqrtdt;
	for(p1 = 1; p1 < timepointsBeforeEvolution; p1++){
		noise[p1] = noise[p1-1]-noise[p1-1]/tConst1*dt + sigma1*randn();
	}
	// console.log(noise);
	return noise
}

// Standard Normal variate using Box-Muller transform.
function randn() {
    var u = 0, v = 0;
    while(u === 0) u = Math.random(); //Converting [0,1) to (0,1)
    while(v === 0) v = Math.random();
    return Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
}

function get_dists(position){
dist = Math.min(Math.abs(position[0]),Math.abs(position[1]))*(2*(position[0]*position[1]>0)-1)
return dist
}

function argMax(array) {
  return [].map.call(array, (x, i) => [x, i]).reduce((r, a) => (a[0] > r[0] ? a : r))[1];
}

function argMin(array) {
  return [].map.call(array, (x, i) => [-x, i]).reduce((r, a) => (a[0] > r[0] ? a : r))[1];
}

var randVal;
var crossVal;
var g = 0;
var count = 0;
var avoids = [];
var sum;
var avg;
var round = [];
var cWinner;

function draw() {
	if (totTime[numVehicles-1]/dt > timepointsBeforeEvolution) {

		for (i = 0; i < numVehicles; i++) {
			histaList.has(vehicleList[i].a)?true:histaList.add(vehicleList[i].a);
			histbList.has(vehicleList[i].b)?true:histbList.add(vehicleList[i].b);
			histwIList.has(vehicleList[i].wI)?true:histwIList.add(vehicleList[i].wI);
			histwCList.has(vehicleList[i].wC)?true:histwCList.add(vehicleList[i].wC);
		}

		count=0;
		g+=1;
		//get winner parameters
		finalParams = [];
		r1 =[];
		//find median score. 
		for (i = 0; i < numVehicles; i++) {
		finalParams.push(avoid_array[i][avoid_array[i].length-1]);
		// sum+=avoid_array[i][avoid_array[i].length-1];
		//setup random noise
		r1.push(euler_maru())
		}
		round.push(g-1)
		avoids.push(quickselect_median(finalParams))

		winnerInd = argMax(finalParams);
		winner =Object.assign({},vehicleList[winnerInd])
		winner.x = center+100*(Math.floor(Math.random()*2)*2-1)
		winner.y =center;
		winner.angle = Math.random()*2*Math.PI;
		winner.color = colors[0];

		finalParams[winnerInd] = -100;
		winner2Ind = argMax(finalParams);
		winner2 =Object.assign({},vehicleList[winner2Ind])
		winner2.x = center+100*(Math.floor(Math.random()*2)*2-1)
		winner2.y =center;
		winner2.angle = Math.random()*2*Math.PI;
		winner2.color = colors[1];


		finalParams[winner2Ind] = -100;
		winner3Ind = argMax(finalParams);
		winner3 =Object.assign({},vehicleList[winner3Ind])
		winner3.x = center+100*(Math.floor(Math.random()*2)*2-1)
		winner3.y =center;
		winner3.angle = Math.random()*2*Math.PI;
		winner3.color = colors[2];
		// re-initialize. 
		pltList =[];
		Plotly.deleteTraces('tester',ints)
		pltList.push({name: 'Leader', y:[], mode: 'lines',line:{color:colors[i]}})

		for (i = 1; i < numVehicles; i++) {
			pltList.push({name: 'Vehicle '.concat(i.toString()), y:[],mode: 'lines',line:{color:colors[i]}})
		}
		Plotly.newPlot('tester',pltList,Object.assign(layout,{title:{text:'Generation '.concat(g)}}));
		// console.log(round,avoids)
		if (g>1){
		Plotly.relayout('tester4',Object.assign(layout4,{xaxis:{range:[-0.1,g-1],title:'Generation'}}));
		}
		Plotly.update('tester4',{y:[avoids]},[0])
		// Plotly.newPlot('tester', pltList,layout);
		vehicleList = [Object.assign({},winner),Object.assign({},winner2),Object.assign({},winner3)];
		hotTime = [[0],[0],[0]];
		time_array = [[],[],[]];
		avoid_array = [[],[],[]];
		totTime = [[0],[0],[0]];
		for (i = 3; i < numVehicles; i++) {
			//crossover
			crossVal = Math.random();
			if (crossVal <0.25){
				//get traits from one of the top 3. 
			vehicleList.push(Object.assign({angle: Math.random()*2*Math.PI,a:vehicleList[Math.floor(Math.random()*3)].a,b:vehicleList[Math.floor(Math.random()*3)].b,wI:vehicleList[Math.floor(Math.random()*3)].wI,wC:vehicleList[Math.floor(Math.random()*3)].wC,color:colors[i],x:center+80*(Math.floor(Math.random()*2)*2-1),y:center},vehicle));
			}else{
			//mutation
			randVal = Math.random();
			randa = randn()*0.5;
			randb = randn()*0.1;
			randwI = randn()*3.;
			randwC = randn()*3.;
			if (randVal<(1./3.)){
				cWinner = winner;
			} else if (randVal>(2./3.)){
				cWinner = winner2;
			} else {
				cWinner = winner3;
			}
			vehicleList.push(Object.assign({angle: Math.random()*2*Math.PI,a:(cWinner.a+randa)>0.01 ? (cWinner.a+randa) : cWinner.a+Math.random()*0.1,b:(cWinner.b+randb)>0.01 ? cWinner.b+randb: cWinner.b+Math.random()*0.1,wI:Math.abs(cWinner.wI+randwI) <25.?cWinner.wI+randwI:cWinner.wI,wC:Math.abs(cWinner.wC+randwC)<25.?cWinner.wC+randwC:cWinner.wC,color:colors[i],x:center+80*(Math.floor(Math.random()*2)*2-1),y:center},vehicle));
			}
			//also reinitialize readout arrays
			avoid_array.push([]);
			time_array.push([]);
			hotTime.push([0.]);
			totTime.push([0.]);
				
		}
		//also update plots of parameters 
		aList = [];
		bList = [];
		wIList = [];
		wCList = [];
		for (i = 0; i < numVehicles; i++) {
			aList.push(vehicleList[i].a);
			bList.push(vehicleList[i].b);
			wIList.push(vehicleList[i].wI);
			wCList.push(vehicleList[i].wC);
		}

	// console.log(aList,bList,wIList,wCList)
		firstTime = 1;
	}
	if((count % 3)==0){
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	ctx.beginPath();
	// adding the "hot" quadrants
	ctx.fillStyle = 'red';
	ctx.globalAlpha = 0.2;
	ctx.arc(canvas.width/2,canvas.width/2,canvas.width/2,3*Math.PI/2,Math.PI, true)
	ctx.lineTo(canvas.width/2,canvas.width/2)
	ctx.fill();
	ctx.closePath();
	ctx.beginPath();

	ctx.fillStyle = 'red';
	ctx.globalAlpha = 0.2;
	ctx.arc(canvas.width/2,canvas.width/2,canvas.width/2,Math.PI/2,0, true)
	ctx.lineTo(canvas.width/2,canvas.width/2)
	ctx.fill();
	ctx.closePath();
	ctx.restore()
	//exterior circle
	ctx.beginPath();
	ctx.globalAlpha = 0.7;
	ctx.arc(canvas.width/2, canvas.height/2,canvas.height/2,0,2*Math.PI, true)
	ctx.stroke()
	ctx.closePath()

	for (i = 0; i < numVehicles; i++) {
		vehicleList[i].draw();
	}

	ctx.restore()
	ctx.globalAlpha = 0.7;
	}
	if(drawing){
		//try to update. if we go out of the region, perform reflection
		for (i = 0; i < numVehicles; i++) {

			//head positions
			hx = vehicleList[i].x + vehicleList[i].width/2*Math.cos(vehicleList[i].angle-Math.PI/2);
			hy =vehicleList[i].y + vehicleList[i].width/2*Math.sin(vehicleList[i].angle-Math.PI/2);

			//// reflect method
			if ((Math.pow(hx-canvas.height/2,2) +Math.pow(hy-canvas.height/2,2) ) > Math.pow(canvas.height*0.49,2)) {
			// find intersection of body axis vector and circle
			vx = Math.cos(vehicleList[i].angle-Math.PI/2)
			vy = Math.sin(vehicleList[i].angle-Math.PI/2)
			a = (Math.pow(vx,2)+Math.pow(vy,2))
			b = 2.*((hx-center)*vx+(hy-center)*vy) 
			c = (Math.pow(hx-center,2)+Math.pow(hy-center,2)) - Math.pow(canvas.width*0.49,2)
			if (Math.pow(b,2) -4.*a*c <0){
				vehicleList[i].angle+= Math.PI;

			} else{
				j1 = (-b +Math.sqrt(Math.pow(b,2) -4.*a*c))/(2.*a)
				j2 = (-b -Math.sqrt(Math.pow(b,2) -4.*a*c))/(2.*a)
				min1 = j1 < j2 ? j1 : j2
				xp = hx + min1*vx
				yp = hy + min1*vy
				 // perform reflection
				ang2 = (Math.atan2(yp-center,xp-center))%(2*Math.PI)
				ang1 = (Math.atan2(vy,vx))%(2*Math.PI)
	

				l00 = [Math.abs(ang1-ang2),Math.abs(ang1-ang2-2*Math.PI),Math.abs(ang1-ang2+2*Math.PI)]
				l01 = [ang1-ang2,ang1-ang2-2*Math.PI,ang1-ang2+2*Math.PI]
				l0 =argMin(l00)

				vehicleList[i].angle -= 2*Math.sign(l01[l0])*(Math.PI/2.-l00[l0])
				vehicleList[i].angle = vehicleList[i].angle % (Math.PI*2)

				//head positions
				hx = vehicleList[i].x + vehicleList[i].width/2*Math.cos(vehicleList[i].angle-Math.PI/2);
				hy =vehicleList[i].y + vehicleList[i].width/2*Math.sin(vehicleList[i].angle-Math.PI/2);

			}



			}

			// following check for hitting the boundary, advance the vehicle in time. 
			//parameters for 2 wheeled robot model
			//nonlinearity
			a = vehicleList[i].a;//5;
			b= vehicleList[i].b;//0.5;
			//ipsi/contra weights
			wI = vehicleList[i].wI;
			wC = vehicleList[i].wC;
			vL_L = vR_R = wI;
			vL_R = vR_L = wC;
			//baseline speed
			v0 = 8./scaleFactor;//slideSpeed.value/scaleFactor;//slideSpeed.value;
			vL_0 = vR_0 = v0;
			//calculate distance of antennae from hot plate, use spline interpolant to calculate temperature

			//antennae positions
			// Lantenna

			Lx = vehicleList[i].x+vehicleList[i].height/2*Math.cos(vehicleList[i].angle-Math.PI/2)+vehicleList[i].width*0.2*Math.cos(vehicleList[i].angle);
			Ly = vehicleList[i].y+vehicleList[i].height/2*Math.sin(vehicleList[i].angle-Math.PI/2)+vehicleList[i].width*0.2*Math.sin(vehicleList[i].angle);
			// Rantenna
			Rx = vehicleList[i].x+vehicleList[i].height/2*Math.cos(vehicleList[i].angle-Math.PI/2)+vehicleList[i].width*0.2*Math.cos(vehicleList[i].angle-Math.PI)
			Ry = vehicleList[i].y+vehicleList[i].height/2*Math.sin(vehicleList[i].angle-Math.PI/2)+vehicleList[i].width*0.2*Math.sin(vehicleList[i].angle-Math.PI)

			// get distances, scale dimensions to that of the arena
			dL = get_dists([Lx-center,Ly-center])*scaleFactor;
			dR = get_dists([Rx-center,Ry-center])*scaleFactor;


			// get head position. 
			Hx = (Lx+Rx)/2. -center;
			Hy = (Ly+Ry)/2. -center;
			hot = get_dists([Hx,Hy])>0 ? 1.0*dt : 0.;

			// console.log(temps(dL),temps(dR));
			sL = (temps(dL) - 25.)/10.;//0.2;
			sR =(temps(dR) - 25.)/10.;// 0.2;

			//calculate wheel speeds
			sL = (1./(1.+Math.exp(-a*sL+b)));
			sR = (1./(1.+Math.exp(-a*sR+b)));
			
			vL = sL*vL_L + sR*vR_L + vL_0+r1[i][count];
			vR = sL*vL_R + sR*vR_R + vR_0-r1[i][count];
			dvdt  =  -0.5*(vL + vR);
			dThetadt = (vL-vR)/b;

			// make avoidance plot. 
			hotTime[i]= parseFloat(hotTime[i])+ parseFloat(hot)
			totTime[i]  = parseFloat(totTime[i]) + dt
			if ((count % 4)==1){
			avoid_array[i] = avoid_array[i].concat(1. - 2.*(hotTime[i] / totTime[i]))
			time_array[i] = time_array[i].concat(totTime[i]);
			}
			vehicleList[i].x += Math.cos(vehicleList[i].angle+Math.PI/2)*dvdt*dt;
			vehicleList[i].y += Math.sin(vehicleList[i].angle+Math.PI/2)*dvdt*dt;
			vehicleList[i].angle+= dThetadt*dt;//0.1*(Math.random()-0.5);
			vehicleList[i].angle%= (Math.PI*2);
			vehicleList[i].angle =  vehicleList[i].angle>0 ? vehicleList[i].angle : 2*Math.PI-vehicleList[i].angle;
			
		}
		if ((count % 4)==1){
		Plotly.update('tester', {y:avoid_array,x:time_array}, ints)
		}
		if(firstTime){
			console.log(histaList)
			trace2_hist = {type: 'scatter',mode: 'markers',x:Array.from(histaList),y:Array.from(histbList),marker:{color:'grey',opacity:0.25}}
			trace3_hist = {type: 'scatter',mode: 'markers',x:Array.from(histwIList),y:Array.from(histwCList),marker:{color:'grey',opacity:0.25}}
			trace2 = {type: 'scatter',mode: 'markers',x:aList,y:bList,marker:{color:colors}}
			trace3 = {type: 'scatter',mode: 'markers',x:wIList,y:wCList,marker:{color:colors}}
			Plotly.deleteTraces('tester2',[0,1])
			Plotly.deleteTraces('tester3',[0,1])

			Plotly.newPlot('tester2',[trace2_hist,trace2],layout2)
			Plotly.newPlot('tester3',[trace3_hist,trace3],layout3)
		}

		firstTime = 0;
		count+=1;
		raf = window.requestAnimationFrame(draw);

	}
}

document.getElementById("startBtn").addEventListener("click",function(e) {
	if(drawing==false){
	raf = window.requestAnimationFrame(draw);
	drawing=true;
};
});

document.getElementById("ffwBtn").addEventListener("click",function(e) {
	if(drawing==true){
	raf = window.requestAnimationFrame(draw);
};
});

document.getElementById("stopBtn").addEventListener("click",function(e) {
	raf = window.cancelAnimationFrame(draw);
	drawing = false;
});

</script>
</body>
</html>


